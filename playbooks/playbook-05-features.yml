---
- name: 5. Install ArgoCD, Prometheus, Grafana, and Kubernetes Dashboard
  hosts: control_plane
  become: true
  environment:
    KUBECONFIG: "{{ kubeconfig_path }}"

  tasks:
    # ============= Validation =============
    - name: Validate required variables
      ansible.builtin.assert:
        that:
          - argocd_domain is defined
          - grafana_domain is defined
          - prometheus_domain is defined
          - dashboard_domain is defined
        fail_msg: "Required domain variables not found in group_vars/all.yml"

    # ============= Setup =============
    - name: Add Helm repositories
      ansible.builtin.shell: |
        helm repo add argo https://argoproj.github.io/argo-helm
        helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
        helm repo add kubernetes-dashboard https://kubernetes.github.io/dashboard/
        helm repo update
      changed_when: false

    - name: Create namespaces
      ansible.builtin.shell: |
        kubectl create namespace argocd --dry-run=client -o yaml | kubectl apply -f -
        kubectl create namespace monitoring --dry-run=client -o yaml | kubectl apply -f -
        kubectl create namespace kubernetes-dashboard --dry-run=client -o yaml | kubectl apply -f -
      changed_when: false

    # ============= ArgoCD Installation =============
    - name: Create ArgoCD values file
      ansible.builtin.copy:
        dest: /tmp/argocd-values.yaml
        content: |
          server:
            replicas: 1
            service:
              type: ClusterIP
            ingress:
              enabled: true
              ingressClassName: nginx
              annotations:
                nginx.ingress.kubernetes.io/ssl-redirect: "false"
                nginx.ingress.kubernetes.io/backend-protocol: "HTTP"
              hosts:
                - {{ argocd_domain }}

          configs:
            params:
              server.insecure: true
            cm:
              url: http://{{ argocd_domain }}

    - name: Install ArgoCD
      ansible.builtin.shell: |
        helm upgrade --install argocd argo/argo-cd \
          --namespace argocd \
          --values /tmp/argocd-values.yaml \
          --wait --timeout=5m

    - name: Get ArgoCD admin password
      ansible.builtin.shell: |
        kubectl -n argocd get secret argocd-initial-admin-secret \
          -o jsonpath="{.data.password}" | base64 -d
      register: argocd_password
      changed_when: false

    # ============= Prometheus & Grafana Installation =============
    - name: Create Prometheus values file
      ansible.builtin.copy:
        dest: /tmp/prometheus-values.yaml
        content: |
          prometheus:
            service:
              type: ClusterIP
            prometheusSpec:
              replicas: 1
              retention: 7d
              storageSpec:
                volumeClaimTemplate:
                  spec:
                    accessModes: ["ReadWriteOnce"]
                    resources:
                      requests:
                        storage: 10Gi
              resources:
                limits:
                  cpu: 500m
                  memory: 1Gi
                requests:
                  cpu: 250m
                  memory: 512Mi
            ingress:
              enabled: true
              ingressClassName: nginx
              annotations:
                nginx.ingress.kubernetes.io/ssl-redirect: "false"
              hosts:
                - {{ prometheus_domain }}

          alertmanager:
            enabled: false

          grafana:
            replicas: 1
            service:
              type: ClusterIP
            adminPassword: {{ grafana_admin_password }}
            persistence:
              enabled: true
              size: 5Gi
            resources:
              limits:
                cpu: 200m
                memory: 256Mi
              requests:
                cpu: 100m
                memory: 128Mi
            ingress:
              enabled: true
              ingressClassName: nginx
              annotations:
                nginx.ingress.kubernetes.io/ssl-redirect: "false"
              hosts:
                - {{ grafana_domain }}
            grafana.ini:
              server:
                root_url: http://{{ grafana_domain }}
            datasources:
              datasources.yaml:
                apiVersion: 1
                datasources:
                - name: Prometheus
                  type: prometheus
                  url: http://kube-prometheus-stack-prometheus.monitoring:9090
                  isDefault: true
            dashboards:
              default:
                kubernetes-cluster:
                  gnetId: 7249
                  datasource: Prometheus
                kubernetes-pods:
                  gnetId: 6417
                  datasource: Prometheus

          kubeStateMetrics:
            enabled: true

          nodeExporter:
            enabled: true

          prometheusOperator:
            resources:
              limits:
                cpu: 200m
                memory: 256Mi
              requests:
                cpu: 100m
                memory: 128Mi

    - name: Install Prometheus Stack
      ansible.builtin.shell: |
        helm upgrade --install kube-prometheus-stack \
          prometheus-community/kube-prometheus-stack \
          --namespace monitoring \
          --values /tmp/prometheus-values.yaml \
          --wait --timeout=10m

    # ============= Kubernetes Dashboard Installation =============
    - name: Create Dashboard values file
      ansible.builtin.copy:
        dest: /tmp/dashboard-values.yaml
        content: |
          service:
            type: ClusterIP
          metricsScraper:
            enabled: true
          resources:
            limits:
              cpu: 100m
              memory: 128Mi
            requests:
              cpu: 50m
              memory: 64Mi
          protocolHttp: true

    - name: Install Kubernetes Dashboard
      ansible.builtin.shell: |
        helm upgrade --install kubernetes-dashboard \
          kubernetes-dashboard/kubernetes-dashboard \
          --namespace kubernetes-dashboard \
          --values /tmp/dashboard-values.yaml \
          --wait --timeout=5m

    - name: Create Dashboard Ingress
      ansible.builtin.shell: |
        kubectl apply -f - <<YAML
        apiVersion: networking.k8s.io/v1
        kind: Ingress
        metadata:
          name: kubernetes-dashboard
          namespace: kubernetes-dashboard
          annotations:
            nginx.ingress.kubernetes.io/ssl-redirect: "false"
            nginx.ingress.kubernetes.io/backend-protocol: "HTTP"
        spec:
          ingressClassName: nginx
          rules:
          - host: {{ dashboard_domain }}
            http:
              paths:
              - path: /
                pathType: Prefix
                backend:
                  service:
                    name: kubernetes-dashboard
                    port:
                      number: 80
        YAML
      changed_when: false

    - name: Create Dashboard admin resources
      ansible.builtin.shell: |
        kubectl apply -f - <<YAML
        apiVersion: v1
        kind: ServiceAccount
        metadata:
          name: admin-user
          namespace: kubernetes-dashboard
        ---
        apiVersion: rbac.authorization.k8s.io/v1
        kind: ClusterRoleBinding
        metadata:
          name: admin-user
        roleRef:
          apiGroup: rbac.authorization.k8s.io
          kind: ClusterRole
          name: cluster-admin
        subjects:
        - kind: ServiceAccount
          name: admin-user
          namespace: kubernetes-dashboard
        ---
        apiVersion: v1
        kind: Secret
        metadata:
          name: admin-user-token
          namespace: kubernetes-dashboard
          annotations:
            kubernetes.io/service-account.name: admin-user
        type: kubernetes.io/service-account-token
        YAML
      changed_when: false

    - name: Wait for Dashboard token
      ansible.builtin.pause:
        seconds: 5

    - name: Get Dashboard token
      ansible.builtin.shell: |
        kubectl get secret admin-user-token -n kubernetes-dashboard \
          -o jsonpath="{.data.token}" | base64 -d
      register: dashboard_token
      changed_when: false

    - name: Get Ingress Controller IP
      ansible.builtin.shell: |
        kubectl get svc -n ingress-nginx ingress-nginx-controller \
          -o jsonpath='{.status.loadBalancer.ingress[0].ip}'
      register: ingress_ip
      retries: 10
      delay: 5
      until: ingress_ip.stdout != ""
      changed_when: false

    # ============= Save Credentials =============
    - name: Save credentials
      ansible.builtin.copy:
        dest: /tmp/k8s-credentials.txt
        content: |
          ================================================
          Kubernetes Management Tools
          ================================================

          ArgoCD:
            URL: http://{{ argocd_domain }}
            Username: admin
            Password: {{ argocd_password.stdout }}

          Grafana:
            URL: http://{{ grafana_domain }}
            Username: admin
            Password: {{ grafana_admin_password }}

          Prometheus:
            URL: http://prometheus.stpay.net

          Kubernetes Dashboard:
            URL: http://{{ dashboard_domain }}
            Token: {{ dashboard_token.stdout }}

          ================================================
          Single Ingress LoadBalancer Configuration
          ================================================

          Ingress Controller IP: {{ ingress_ip.stdout }}

          All services route through a single Ingress NGINX
          LoadBalancer using host-based routing.

          ================================================
          DNS Configuration
          ================================================

          Add these entries to your DNS or /etc/hosts:

          {{ ingress_ip.stdout }}  {{ argocd_domain }}
          {{ ingress_ip.stdout }}  {{ grafana_domain }}
          {{ ingress_ip.stdout }}  prometheus.stpay.net
          {{ ingress_ip.stdout }}  {{ dashboard_domain }}

          ================================================
      delegate_to: localhost
      become: false

    # ============= Verification =============
    - name: Verify all ingress resources
      ansible.builtin.shell: |
        echo "=== Ingress Resources ==="
        kubectl get ingress -A
        echo ""
        echo "=== Services ==="
        kubectl get svc -n argocd,monitoring,kubernetes-dashboard
      register: verification
      changed_when: false

    # ============= Display Summary =============
    - name: Display summary
      ansible.builtin.debug:
        msg: |
          ================================================
          Installation Complete!
          ================================================

          ðŸš€ ArgoCD:     http://{{ argocd_domain }}
          ðŸ“Š Grafana:    http://{{ grafana_domain }}
          ðŸ“ˆ Prometheus: http://prometheus.stpay.net
          ðŸŽ›ï¸  Dashboard:  http://{{ dashboard_domain }}

          âš™ï¸  Ingress LoadBalancer IP: {{ ingress_ip.stdout }}

          ================================================
          DNS Configuration Required
          ================================================

          Add to your DNS server or /etc/hosts:

          {{ ingress_ip.stdout }}  {{ argocd_domain }}
          {{ ingress_ip.stdout }}  {{ grafana_domain }}
          {{ ingress_ip.stdout }}  prometheus.stpay.net
          {{ ingress_ip.stdout }}  {{ dashboard_domain }}

          ================================================
          Access Information
          ================================================

          ArgoCD Password: {{ argocd_password.stdout }}
          Grafana Password: {{ grafana_admin_password }}

          Dashboard Token: {{ dashboard_token.stdout }}

          ðŸ“ Full credentials: /tmp/k8s-credentials.txt

          ================================================
          Verification
          ================================================

          {{ verification.stdout }}

          ================================================
