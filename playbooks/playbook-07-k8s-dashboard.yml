---
- name: 7 Install Kubernetes Dashboard
  hosts: control_plane
  become: true
  environment:
    KUBECONFIG: "{{ kubeconfig_path }}"

  tasks:
    # ============= Validation =============
    - name: Validate Kubernetes Dashboard domain
      ansible.builtin.assert:
        that:
          - dashboard_domain is defined
        fail_msg: "dashboard_domain not found in group_vars/all.yml"

    # ============= Setup =============
    - name: Add Kubernetes Dashboard Helm repository
      ansible.builtin.command:
        cmd: helm repo add kubernetes-dashboard https://kubernetes.github.io/dashboard/
      register: repo_add_output
      changed_when: "'has been added' in repo_add_output.stdout"
      failed_when: repo_add_output.rc != 0 and 'already exists' not in repo_add_output.stderr

    - name: Update Helm repositories
      ansible.builtin.command:
        cmd: helm repo update
      register: repo_update_output
      changed_when: "'Update Complete' in repo_update_output.stdout"

    - name: Create kubernetes-dashboard namespace
      ansible.builtin.command:
        cmd: kubectl create namespace kubernetes-dashboard
      register: ns_result
      changed_when: "'created' in ns_result.stdout"
      failed_when: ns_result.rc != 0 and 'already exists' not in ns_result.stderr

    # ============= Installation =============
    - name: Deploy Kubernetes Dashboard v2.7.0 (Stable)
      ansible.builtin.shell: |
        kubectl apply -f https://raw.githubusercontent.com/kubernetes/dashboard/v2.7.0/aio/deploy/recommended.yaml
      changed_when: false

    - name: Wait for dashboard deployment
      ansible.builtin.pause:
        seconds: 10

    # ============= TLS for Ingress =============
    - name: Generate self-signed TLS cert for dashboard (if not present)
      ansible.builtin.shell: |
        openssl req -x509 -nodes -days 3650 -newkey rsa:2048 \
          -subj "/CN={{ dashboard_domain }}" \
          -keyout /tmp/dashboard.key -out /tmp/dashboard.crt
      args:
        creates: /tmp/dashboard.crt
      changed_when: false

    - name: Create/Update dashboard TLS secret
      ansible.builtin.shell: |
        kubectl -n kubernetes-dashboard create secret tls dashboard-tls \
          --cert=/tmp/dashboard.crt --key=/tmp/dashboard.key \
          --dry-run=client -o yaml | kubectl apply -f -
      changed_when: false

    # ============= Create Admin User =============
    - name: Create admin user and cluster role binding
      ansible.builtin.shell: |
        kubectl apply -f - <<YAML
        apiVersion: v1
        kind: ServiceAccount
        metadata:
          name: admin-user
          namespace: kubernetes-dashboard
        ---
        apiVersion: rbac.authorization.k8s.io/v1
        kind: ClusterRoleBinding
        metadata:
          name: admin-user
        roleRef:
          apiGroup: rbac.authorization.k8s.io
          kind: ClusterRole
          name: cluster-admin
        subjects:
        - kind: ServiceAccount
          name: admin-user
          namespace: kubernetes-dashboard
        YAML
      changed_when: false

    - name: Wait for admin user to be ready
      ansible.builtin.pause:
        seconds: 5

    - name: Get Dashboard admin token (permanent - 10 years)
      ansible.builtin.shell: |
        kubectl -n kubernetes-dashboard create token admin-user --duration=87600h
      register: dashboard_token
      changed_when: false
      retries: 5
      delay: 2
    # ============= Create Ingress =============
    - name: Create Dashboard Ingress
      ansible.builtin.shell: |
        kubectl apply -f - <<YAML
        apiVersion: networking.k8s.io/v1
        kind: Ingress
        metadata:
          name: kubernetes-dashboard
          namespace: kubernetes-dashboard
          annotations:
            nginx.ingress.kubernetes.io/ssl-redirect: "true"
            nginx.ingress.kubernetes.io/backend-protocol: "HTTPS"
        spec:
          ingressClassName: nginx
          tls:
          - hosts:
            - {{ dashboard_domain }}
            secretName: dashboard-tls
          rules:
          - host: {{ dashboard_domain }}
            http:
              paths:
              - path: /
                pathType: Prefix
                backend:
                  service:
                    name: kubernetes-dashboard
                    port:
                      number: 443
        YAML
      changed_when: false

    # ============= Display Results =============
    - name: Display Kubernetes Dashboard installation summary
      ansible.builtin.debug:
        msg: |
          ================================================
          Kubernetes Dashboard Installation Complete!
          ================================================

          ðŸŽ›ï¸  Dashboard URL: https://{{ dashboard_domain }}

          ================================================
          Access Token
          ================================================

          Token: {{ dashboard_token.stdout }}

          ================================================
          How to Access
          ================================================

          1. Open browser: https://{{ dashboard_domain }}
          2. Click "Token" option at login
          3. Paste the token above
          4. Click "Sign In"

          ================================================

    - name: Save Kubernetes Dashboard credentials
      ansible.builtin.copy:
        dest: /tmp/dashboard-credentials.txt
        content: |
          Kubernetes Dashboard Credentials
          ==================================

          URL: https://{{ dashboard_domain }}

          Admin Token:
          {{ dashboard_token.stdout }}

          How to Access:
          1. Open the URL above in your browser
          2. Select "Token" option at login page
          3. Paste the token
          4. Click "Sign In"

      delegate_to: localhost
      become: false
