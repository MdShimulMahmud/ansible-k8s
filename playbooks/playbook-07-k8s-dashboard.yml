---
- name: 7 Install Kubernetes Dashboard
  hosts: control_plane
  become: true
  environment:
    KUBECONFIG: "{{ kubeconfig_path }}"

  tasks:
    # ============= Validation =============
    - name: Validate Kubernetes Dashboard domain
      ansible.builtin.assert:
        that:
          - dashboard_domain is defined
        fail_msg: "dashboard_domain not found in group_vars/all.yml"

    # ============= Setup =============
    - name: Add Kubernetes Dashboard Helm repository
      ansible.builtin.shell: |
        helm repo add kubernetes-dashboard https://kubernetes.github.io/dashboard/
        helm repo update
      changed_when: false

    - name: Create kubernetes-dashboard namespace
      ansible.builtin.shell: |
        kubectl create namespace kubernetes-dashboard --dry-run=client -o yaml | kubectl apply -f -
      changed_when: false

    # ============= Installation =============
    - name: Create Dashboard values file
      ansible.builtin.copy:
        dest: /tmp/dashboard-values.yaml
        content: |
          service:
            type: ClusterIP
          metricsScraper:
            enabled: true
          resources:
            limits:
              cpu: 100m
              memory: 128Mi
            requests:
              cpu: 50m
              memory: 64Mi
          protocolHttp: true

    - name: Install Kubernetes Dashboard
      ansible.builtin.shell: |
        helm upgrade --install kubernetes-dashboard \
          kubernetes-dashboard/kubernetes-dashboard \
          --namespace kubernetes-dashboard \
          --values /tmp/dashboard-values.yaml \
          --wait --timeout=5m
      register: dashboard_install

    # ============= Create Ingress =============
    - name: Create Dashboard Ingress
      ansible.builtin.shell: |
        kubectl apply -f - <<YAML
        apiVersion: networking.k8s.io/v1
        kind: Ingress
        metadata:
          name: kubernetes-dashboard
          namespace: kubernetes-dashboard
          annotations:
            nginx.ingress.kubernetes.io/ssl-redirect: "false"
            nginx.ingress.kubernetes.io/backend-protocol: "HTTP"
        spec:
          ingressClassName: nginx
          rules:
          - host: {{ dashboard_domain }}
            http:
              paths:
              - path: /
                pathType: Prefix
                backend:
                  service:
                    name: kubernetes-dashboard
                    port:
                      number: 80
        YAML
      changed_when: false

    # ============= Create Admin User =============
    - name: Create Dashboard admin resources
      ansible.builtin.shell: |
        kubectl apply -f - <<YAML
        apiVersion: v1
        kind: ServiceAccount
        metadata:
          name: admin-user
          namespace: kubernetes-dashboard
        ---
        apiVersion: rbac.authorization.k8s.io/v1
        kind: ClusterRoleBinding
        metadata:
          name: admin-user
        roleRef:
          apiGroup: rbac.authorization.k8s.io
          kind: ClusterRole
          name: cluster-admin
        subjects:
        - kind: ServiceAccount
          name: admin-user
          namespace: kubernetes-dashboard
        ---
        apiVersion: v1
        kind: Secret
        metadata:
          name: admin-user-token
          namespace: kubernetes-dashboard
          annotations:
            kubernetes.io/service-account.name: admin-user
        type: kubernetes.io/service-account-token
        YAML
      changed_when: false

    - name: Wait for Dashboard token secret
      ansible.builtin.pause:
        seconds: 5

    - name: Get Dashboard admin token
      ansible.builtin.shell: |
        kubectl get secret admin-user-token -n kubernetes-dashboard \
          -o jsonpath="{.data.token}" | base64 -d
      register: dashboard_token
      changed_when: false
      retries: 5
      delay: 5

    # ============= Display Results =============
    - name: Display Kubernetes Dashboard installation summary
      ansible.builtin.debug:
        msg: |
          ================================================
          Kubernetes Dashboard Installation Complete!
          ================================================

          ðŸŽ›ï¸  Dashboard URL: http://{{ dashboard_domain }}

          ================================================
          Access Token
          ================================================

          Token: {{ dashboard_token.stdout }}

          ================================================
          Ingress Configuration
          ================================================

          Host: {{ dashboard_domain }}
          Namespace: kubernetes-dashboard
          Service: kubernetes-dashboard
          Port: 80

          ================================================

    - name: Save Kubernetes Dashboard credentials
      ansible.builtin.copy:
        dest: /tmp/dashboard-credentials.txt
        content: |
          Kubernetes Dashboard Credentials
          ==================================

          URL: http://{{ dashboard_domain }}

          Admin Token:
          {{ dashboard_token.stdout }}

      delegate_to: localhost
      become: false
