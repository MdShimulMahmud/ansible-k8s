---
- name: 7 Install Kubernetes Dashboard
  hosts: control_plane
  become: true
  environment:
    KUBECONFIG: "{{ kubeconfig_path }}"

  tasks:
    # ============= Validation =============
    - name: Validate Kubernetes Dashboard domain
      ansible.builtin.assert:
        that:
          - dashboard_domain is defined
        fail_msg: "dashboard_domain not found in group_vars/all.yml"

    # ============= Setup Namespace =============
    - name: Create kubernetes-dashboard namespace
      kubernetes.core.k8s:
        name: kubernetes-dashboard
        api_version: v1
        kind: Namespace
        state: present

    # ============= Installation =============
    - name: Deploy Kubernetes Dashboard v2.7.0
      ansible.builtin.shell: |
        kubectl apply -f https://raw.githubusercontent.com/kubernetes/dashboard/v2.7.0/aio/deploy/recommended.yaml
      register: dashboard_install
      changed_when: "'created' in dashboard_install.stdout or 'unchanged' not in dashboard_install.stdout"

    # ============= Create Admin User =============
    - name: Create admin user and cluster role binding
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: ServiceAccount
          metadata:
            name: admin-user
            namespace: kubernetes-dashboard

    - name: Create ClusterRoleBinding for admin user
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: rbac.authorization.k8s.io/v1
          kind: ClusterRoleBinding
          metadata:
            name: admin-user
          roleRef:
            apiGroup: rbac.authorization.k8s.io
            kind: ClusterRole
            name: cluster-admin
          subjects:
            - kind: ServiceAccount
              name: admin-user
              namespace: kubernetes-dashboard

    # ============= Create Ingress =============
    - name: Create Dashboard Ingress
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: networking.k8s.io/v1
          kind: Ingress
          metadata:
            name: kubernetes-dashboard
            namespace: kubernetes-dashboard
            annotations:
              nginx.ingress.kubernetes.io/ssl-redirect: "false"
              nginx.ingress.kubernetes.io/backend-protocol: "HTTPS"
          spec:
            ingressClassName: nginx
            rules:
              - host: "{{ dashboard_domain }}"
                http:
                  paths:
                    - path: /
                      pathType: Prefix
                      backend:
                        service:
                          name: kubernetes-dashboard
                          port:
                            number: 443

    # ============= Wait for Deployment =============
    - name: Wait for Kubernetes Dashboard deployment to be ready
      kubernetes.core.k8s_info:
        api_version: apps/v1
        kind: Deployment
        name: kubernetes-dashboard
        namespace: kubernetes-dashboard
        wait: true
        wait_sleep: 10
        wait_timeout: 300
      register: deploy_status

    # ============= Token Generation =============
    - name: Get Dashboard admin token
      ansible.builtin.shell: |
        kubectl -n kubernetes-dashboard create token admin-user --duration=87600h
      register: dashboard_token
      changed_when: false

    # ============= Display Results =============
    - name: Display Kubernetes Dashboard installation summary
      ansible.builtin.debug:
        msg: |
          ================================================
          Kubernetes Dashboard Installation Complete!
          ================================================

          üéõÔ∏è  Dashboard URL: http://{{ dashboard_domain }}

          ================================================
          Access Token
          ================================================

          Token: {{ dashboard_token.stdout }}

          ================================================
          How to Access
          ================================================

          1. Open browser: http://{{ dashboard_domain }}
          2. Click "Token" option at login
          3. Paste the token above
          4. Click "Sign In"

          ================================================

    - name: Save Kubernetes Dashboard credentials
      ansible.builtin.copy:
        dest: /tmp/dashboard-credentials.txt
        content: |
          Kubernetes Dashboard Credentials
          ==================================

          URL: http://{{ dashboard_domain }}

          Admin Token:
          {{ dashboard_token.stdout }}

          How to Access:
          1. Open the URL above in your browser
          2. Select "Token" option at login page
          3. Paste the token
          4. Click "Sign In"
      delegate_to: localhost
      become: false
