---
- name: 7 Install Kubernetes Dashboard
  hosts: control_plane
  become: true
  environment:
    KUBECONFIG: "{{ kubeconfig_path }}"

  tasks:
    # ============= Validation =============
    - name: Validate Kubernetes Dashboard domain
      ansible.builtin.assert:
        that:
          - dashboard_domain is defined
        fail_msg: "dashboard_domain not found in group_vars/all.yml"

    # ============= Setup =============
    - name: Add Kubernetes Dashboard Helm repository
      ansible.builtin.shell: |
        helm repo add kubernetes-dashboard https://kubernetes.github.io/dashboard/
        helm repo update
      changed_when: false

    - name: Create kubernetes-dashboard namespace
      ansible.builtin.shell: |
        kubectl create namespace kubernetes-dashboard --dry-run=client -o yaml | kubectl apply -f -
      changed_when: false

    # ============= Installation =============
    - name: Create Dashboard values file
      ansible.builtin.copy:
        dest: /tmp/dashboard-values.yaml
        content: |
          kong:
            enabled: false
          nginx:
            enabled: true
          cert-manager:
            enabled: false
          app:
            ingress:
              enabled: true
              ingressClassName: nginx
              hosts:
                - {{ dashboard_domain }}
              annotations:
                nginx.ingress.kubernetes.io/ssl-redirect: "false"
          api:
            containers:
              args:
                - --token-ttl=0
          metricsScraper:
            enabled: true

    - name: Install Kubernetes Dashboard
      ansible.builtin.shell: |
        helm upgrade --install kubernetes-dashboard \
          kubernetes-dashboard/kubernetes-dashboard \
          --namespace kubernetes-dashboard \
          --values /tmp/dashboard-values.yaml \
          --wait --timeout=5m
      register: dashboard_install

    # ============= Create Ingress =============
    # Ingress is now managed by the Helm chart
    - name: Wait for Dashboard to be ready
      ansible.builtin.pause:
        seconds: 10

    # ============= Create Admin User =============
    - name: Create Dashboard admin resources
      ansible.builtin.shell: |
        kubectl apply -f - <<YAML
        apiVersion: v1
        kind: ServiceAccount
        metadata:
          name: admin-user
          namespace: kubernetes-dashboard
        ---
        apiVersion: rbac.authorization.k8s.io/v1
        kind: ClusterRoleBinding
        metadata:
          name: admin-user
        roleRef:
          apiGroup: rbac.authorization.k8s.io
          kind: ClusterRole
          name: cluster-admin
        subjects:
        - kind: ServiceAccount
          name: admin-user
          namespace: kubernetes-dashboard
        ---
        apiVersion: v1
        kind: Secret
        metadata:
          name: admin-user-token
          namespace: kubernetes-dashboard
          annotations:
            kubernetes.io/service-account.name: admin-user
        type: kubernetes.io/service-account-token
        YAML
      changed_when: false

    - name: Wait for Dashboard token secret
      ansible.builtin.pause:
        seconds: 5

    - name: Ensure long-lived admin token secret
      ansible.builtin.shell: |
        kubectl apply -f - <<YAML
        apiVersion: v1
        kind: Secret
        metadata:
          name: admin-user-perm-token
          namespace: kubernetes-dashboard
          annotations:
            kubernetes.io/service-account.name: admin-user
        type: kubernetes.io/service-account-token
        YAML
      changed_when: false

    - name: Get Dashboard admin token (permanent)
      ansible.builtin.shell: |
        set -e
        if kubectl -n kubernetes-dashboard get secret admin-user-perm-token >/dev/null 2>&1; then
          secret_name=admin-user-perm-token
        else
          secret_name=$(kubectl -n kubernetes-dashboard get secret | awk '/admin-user-token/{print $1; exit}')
        fi
        kubectl -n kubernetes-dashboard get secret "$secret_name" -o jsonpath="{.data.token}" | base64 -d
      register: dashboard_token
      changed_when: false
      retries: 5
      delay: 5

    # ============= Display Results =============
    - name: Display Kubernetes Dashboard installation summary
      ansible.builtin.debug:
        msg: |
          ================================================
          Kubernetes Dashboard Installation Complete!
          ================================================

          üéõÔ∏è  Dashboard URL: http://{{ dashboard_domain }}

          ================================================
          Access Token
          ================================================

          Token: {{ dashboard_token.stdout }}

          ================================================
          Ingress Configuration
          ================================================

          Host: {{ dashboard_domain }}
          Namespace: kubernetes-dashboard
          Gateway: nginx (no Kong)
          Protocol: HTTP

          ================================================

    - name: Save Kubernetes Dashboard credentials
      ansible.builtin.copy:
        dest: /tmp/dashboard-credentials.txt
        content: |
          Kubernetes Dashboard Credentials
          ==================================

          URL: http://{{ dashboard_domain }}

          Admin Token:
          {{ dashboard_token.stdout }}

      delegate_to: localhost
      become: false
