---
- name: 5 Install ArgoCD
  hosts: control_plane
  become: true
  environment:
    KUBECONFIG: "{{ kubeconfig_path }}"

  tasks:
    # ============= Validation =============
    - name: Validate ArgoCD domain
      ansible.builtin.assert:
        that:
          - argocd_domain is defined
        fail_msg: "argocd_domain not found in group_vars/all.yml"

    # ============= Setup =============
    - name: Add ArgoCD Helm repository
      ansible.builtin.shell: |
        helm repo add argo https://argoproj.github.io/argo-helm
        helm repo update
      changed_when: false

    - name: Create argocd namespace
      ansible.builtin.shell: |
        kubectl create namespace argocd --dry-run=client -o yaml | kubectl apply -f -
      changed_when: false

    # ============= Installation =============
    - name: Create ArgoCD values file
      ansible.builtin.copy:
        dest: /tmp/argocd-values.yaml
        content: |
          server:
            replicas: 1
            service:
              type: ClusterIP
            ingress:
              enabled: true
              ingressClassName: nginx
              annotations:
                nginx.ingress.kubernetes.io/ssl-redirect: "false"
                nginx.ingress.kubernetes.io/backend-protocol: "HTTP"
              hosts:
                - {{ argocd_domain }}
          configs:
            params:
              server.insecure: true
            cm:
              url: http://{{ argocd_domain }}

    - name: Install ArgoCD
      ansible.builtin.shell: |
        helm upgrade --install argocd argo/argo-cd \
          --namespace argocd \
          --values /tmp/argocd-values.yaml \
          --wait --timeout=5m
      register: argocd_install

    - name: Wait for ArgoCD to be ready
      ansible.builtin.pause:
        seconds: 10

    - name: Get ArgoCD admin password
      ansible.builtin.shell: |
        kubectl -n argocd get secret argocd-initial-admin-secret \
          -o jsonpath="{.data.password}" | base64 -d
      register: argocd_password
      changed_when: false
      retries: 5
      delay: 5

    # ============= Display Results =============
    - name: Display ArgoCD installation summary
      ansible.builtin.debug:
        msg: |
          ================================================
          ArgoCD Installation Complete!
          ================================================

          ðŸš€ ArgoCD URL: http://{{ argocd_domain }}
          ðŸ‘¤ Username: admin
          ðŸ” Password: {{ argocd_password.stdout }}

          ================================================
          Ingress Configuration
          ================================================

          Host: {{ argocd_domain }}
          Namespace: argocd
          Service: argocd-server
          Port: 80

          ================================================
      when: argocd_password.stdout | length > 0

    - name: Save ArgoCD credentials
      ansible.builtin.copy:
        dest: /tmp/argocd-credentials.txt
        content: |
          ArgoCD Credentials
          ==================

          URL: http://{{ argocd_domain }}
          Username: admin
          Password: {{ argocd_password.stdout }}

      delegate_to: localhost
      become: false
